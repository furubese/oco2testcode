<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CO₂ 濃度可視化マップ - 時系列表示</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
    }

    .controls {
      position: absolute;
      top: 10px;
      left: 60px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 200px;
      max-width: 220px;
    }

    .controls h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .date-selector {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 5px;
    }

    .date-selector select {
      padding: 6px 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      background: white;
      cursor: pointer;
    }

    .date-selector select:first-child {
      flex: 1;
    }

    .date-selector select:last-child {
      flex: 0.7;
    }


    .controls .status {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
      line-height: 1.3;
    }

    .legend {
      position: absolute;
      bottom: 30px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .legend h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 1px solid #333;
    }

    .co2-popup {
      font-size: 14px;
      line-height: 1.4;
    }

    .gradient-marker {
      background: transparent !important;
      border: none !important;
    }

  </style>
</head>
<body>
  <div class="controls">
    <h3>CO₂異常値表示</h3>
    <div class="date-selector">
      <select id="yearSelect" onchange="loadDataForSelectedMonth()"></select>
      <select id="monthSelect" onchange="loadDataForSelectedMonth()">
        <option value="01">1月</option>
        <option value="02">2月</option>
        <option value="03">3月</option>
        <option value="04">4月</option>
        <option value="05">5月</option>
        <option value="06" selected>6月</option>
        <option value="07">7月</option>
        <option value="08">8月</option>
        <option value="09">9月</option>
        <option value="10">10月</option>
        <option value="11">11月</option>
        <option value="12">12月</option>
      </select>
    </div>
    <div class="status" id="status">年月を選択してください</div>
  </div>

  <div class="legend">
    <h4>CO₂濃度 (ppm)</h4>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #d73027;"></div>
      <span>≥ 420 (非常に高い)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fc8d59;"></div>
      <span>418-420 (高い)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fee08b;"></div>
      <span>415-418 (やや高い)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #d9ef8b;"></div>
      <span>412-415 (普通)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #91bfdb;"></div>
      <span>< 412 (低い)</span>
    </div>
  </div>

  <div id="map"></div>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // グローバル変数
    let map;
    let co2Layer = null;

    // 年セレクトボックスを初期化
    function initYearSelect() {
      const yearSelect = document.getElementById('yearSelect');
      const currentYear = new Date().getFullYear();
      const startYear = 2020;
      const endYear = 2025;

      for (let year = endYear; year >= startYear; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        if (year === 2023) {
          option.selected = true;
        }
        yearSelect.appendChild(option);
      }
    }

    // マップ初期化
    function initMap() {
      try {
        map = L.map('map', {
          worldCopyJump: false,
          maxBounds: null,
          maxBoundsViscosity: 0.0
        }).setView([35, 135], 2);

        // OpenStreetMap タイル追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 18,
          noWrap: false
        }).addTo(map);

        // マップ移動時のイベントリスナー追加
        let isAdjusting = false; // 無限ループ防止フラグ
        map.on('moveend', function() {
          if (isAdjusting) return;

          const center = map.getCenter();
          const lng = center.lng;

          // 経度が±180度を大きく超えたら、マップ中心を調整
          if (lng > 180 || lng < -180) {
            isAdjusting = true;
            let newLng = lng;
            while (newLng > 180) newLng -= 360;
            while (newLng < -180) newLng += 360;

            map.setView([center.lat, newLng], map.getZoom(), { animate: false });

            setTimeout(function() {
              isAdjusting = false;
            }, 100);
          }
        });

        updateStatus('マップ初期化完了');
      } catch (error) {
        console.error('Map initialization failed:', error);
        updateStatus('マップ初期化に失敗');
      }
    }

    // ステータス更新
    function updateStatus(message) {
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.textContent = message;
      }
    }


    // CO2濃度に基づく色分け関数
    function getCO2Color(co2) {
      if (co2 >= 420) return '#d73027';      // 赤 - 非常に高い
      else if (co2 >= 418) return '#fc8d59'; // オレンジ - 高い
      else if (co2 >= 415) return '#fee08b'; // 黄色 - やや高い
      else if (co2 >= 412) return '#d9ef8b'; // 薄緑 - 普通
      else return '#91bfdb';                 // 青 - 低い
    }


    // CO2データをマップに追加
    function addCO2DataToMap(geoJsonData) {
      if (!map) {
        updateStatus('マップが初期化されていません');
        return;
      }

      // 既存のレイヤーを削除
      if (co2Layer) {
        map.removeLayer(co2Layer);
      }

      // マーカーを複製して世界地図のループに対応
      const expandedFeatures = [];
      geoJsonData.features.forEach(feature => {
        const coords = feature.geometry.coordinates;
        // 元の位置
        expandedFeatures.push(feature);
        // 西側の複製 (-360)
        expandedFeatures.push({
          ...feature,
          geometry: {
            ...feature.geometry,
            coordinates: [coords[0] - 360, coords[1]]
          }
        });
        // 東側の複製 (+360)
        expandedFeatures.push({
          ...feature,
          geometry: {
            ...feature.geometry,
            coordinates: [coords[0] + 360, coords[1]]
          }
        });
      });

      const expandedData = {
        type: 'FeatureCollection',
        features: expandedFeatures
      };

      co2Layer = L.geoJSON(expandedData, {
        pointToLayer: function(feature, latlng) {
          const co2 = feature.properties.xco2;
          const deviation = feature.properties.deviation_ppm;
          const color = getCO2Color(co2);

          // 偏差(deviation_ppm)に応じて円のサイズを変更
          let radius = 12;  // デフォルト
          if (deviation >= 10) radius = 40;       // 40ppm以上: 特大
          else if (deviation >= 8) radius = 30;  // 30-40ppm: 超大
          else if (deviation >= 6) radius = 20;  // 20-30ppm: 大
          else if (deviation >= 4) radius = 15;  // 15-20ppm: 中大
          else if (deviation >= 2) radius = 10;  // 10-15ppm: 中
          else radius = 5;                        // 10ppm未満: 小

          // グラデーション円をDivIconで作成
          const size = radius * 2;
          const icon = L.divIcon({
            className: 'gradient-marker',
            html: '<div style="width: ' + size + 'px; height: ' + size + 'px; ' +
                  'border-radius: 50%; ' +
                  'background: radial-gradient(circle, ' + color + ' 0%, ' + color + '99 40%, transparent 70%); ' +
                  'transform: translate(-50%, -50%);"></div>',
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
          });

          return L.marker(latlng, { icon: icon });
        },
        onEachFeature: function(feature, layer) {
          const props = feature.properties;
          const co2Value = props.xco2;
          const uncertainty = props.xco2_uncertainty;
          const severity = props.severity || 'unknown';
          const zscore = props.zscore;
          const deviation = props.deviation_ppm;
          const baseline = props.baseline_mean;
          const detectionDays = props.detection_days;
          const detectionFiles = props.detection_files || [];

          // 異常度の日本語表記
          let severityText = '';
          if (severity === 'high') severityText = '高';
          else if (severity === 'medium') severityText = '中';
          else if (severity === 'low') severityText = '低';
          else severityText = severity;

          // ランク判定
          let rank = '';
          if (co2Value >= 420) rank = '非常に高い';
          else if (co2Value >= 418) rank = '高い';
          else if (co2Value >= 415) rank = 'やや高い';
          else if (co2Value >= 412) rank = '普通';
          else rank = '低い';

          // 緯度経度を取得
          const coords = feature.geometry.coordinates;
          const lon = coords[0].toFixed(4);
          const lat = coords[1].toFixed(4);

          layer.bindPopup(
            '<div class="co2-popup">' +
            '<h4 style="margin: 0 0 8px 0; color: ' + getCO2Color(co2Value) + ';">CO₂濃度: ' + co2Value.toFixed(2) + ' ppm</h4>' +
            '<div style="margin-bottom: 4px;"><strong>緯度:</strong> ' + lat + '°</div>' +
            '<div style="margin-bottom: 4px;"><strong>経度:</strong> ' + lon + '°</div>' +
            '<div style="margin-bottom: 4px;"><strong>不確実性:</strong> ±' + uncertainty.toFixed(2) + ' ppm</div>' +
            '<div style="margin-bottom: 4px;"><strong>異常度:</strong> ' + severityText + '</div>' +
            '<div style="margin-bottom: 4px;"><strong>検出日数:</strong> ' + detectionDays + '日</div>' +
            '<div style="margin-bottom: 4px;"><strong>基準値:</strong> ' + baseline.toFixed(2) + ' ppm</div>' +
            '<div style="margin-bottom: 4px;"><strong>偏差:</strong> +' + deviation.toFixed(2) + ' ppm</div>' +
            '<div style="margin-bottom: 4px;"><strong>Z-Score:</strong> ' + zscore.toFixed(2) + '</div>' +
            '<div style="font-size: 11px; color: #666; margin-top: 8px;"><strong>検出ファイル数:</strong> ' + detectionFiles.length + '個</div>' +
            '</div>',
            {
              maxWidth: 320
            }
          );

          // 元のサイズを計算して保存（偏差に基づく）
          const color = getCO2Color(co2Value);
          let radius = 12;
          if (deviation >= 10) radius = 40;
          else if (deviation >= 8) radius = 30;
          else if (deviation >= 6) radius = 20;
          else if (deviation >= 4) radius = 15;
          else if (deviation >= 2) radius = 10;
          else radius = 5;

          const originalSize = radius * 2;
          const hoverSize = originalSize + 8;

          // ホバー状態を管理
          let isHovered = false;

          // ホバー効果
          layer.on('mouseover', function(e) {
            if (isHovered) return; // 既にホバー中なら何もしない
            isHovered = true;

            const newIcon = L.divIcon({
              className: 'gradient-marker',
              html: '<div style="width: ' + hoverSize + 'px; height: ' + hoverSize + 'px; ' +
                    'border-radius: 50%; ' +
                    'background: radial-gradient(circle, ' + color + ' 0%, ' + color + '99 40%, transparent 70%); ' +
                    'transform: translate(-50%, -50%);"></div>',
              iconSize: [hoverSize, hoverSize],
              iconAnchor: [hoverSize / 2, hoverSize / 2]
            });
            this.setIcon(newIcon);
          });

          layer.on('mouseout', function(e) {
            if (!isHovered) return; // ホバー中でなければ何もしない
            isHovered = false;

            const originalIcon = L.divIcon({
              className: 'gradient-marker',
              html: '<div style="width: ' + originalSize + 'px; height: ' + originalSize + 'px; ' +
                    'border-radius: 50%; ' +
                    'background: radial-gradient(circle, ' + color + ' 0%, ' + color + '99 40%, transparent 70%); ' +
                    'transform: translate(-50%, -50%);"></div>',
              iconSize: [originalSize, originalSize],
              iconAnchor: [originalSize / 2, originalSize / 2]
            });
            this.setIcon(originalIcon);
          });
        }
      }).addTo(map);

      updateStatus(geoJsonData.features.length + '件のCO₂データを表示中');
    }

    // 選択された年月のデータを読み込む
    async function loadDataForSelectedMonth() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const year = yearSelect.value;
      const month = monthSelect.value;

      if (!year || !month) {
        updateStatus('年月を選択してください');
        return;
      }

      try {
        const yearMonth = year + month;
        const filename = `anomalies${yearMonth}.geojson`;

        updateStatus(`${year}年${month}月のデータ読込中...`);

        // キャッシュバスター: タイムスタンプをクエリパラメータに追加
        const timestamp = new Date().getTime();
        const response = await fetch(`${filename}?t=${timestamp}`);

        if (!response.ok) {
          throw new Error(`ファイルが見つかりません: ${filename}`);
        }

        const geoJsonData = await response.json();
        console.log('Loaded CO2 anomaly data:', geoJsonData.features.length, 'points');

        addCO2DataToMap(geoJsonData);
        updateStatus(`${year}年${month}月表示 (${geoJsonData.features.length}地点)`);

      } catch (error) {
        console.error('Failed to load data:', error);
        updateStatus(`エラー: ${error.message}`);
      }
    }

    // ページ読み込み時に初期化
    window.addEventListener('load', function() {
      // 年セレクトボックスを初期化
      initYearSelect();

      // Leafletが読み込まれるまで少し待つ
      setTimeout(function() {
        if (typeof L !== 'undefined') {
          initMap();
        } else {
          updateStatus('Leafletライブラリの読み込みに失敗');
        }
      }, 100);
    });

  </script>
</body>
</html>
