# タスク9: 推論結果の表示 - 手動テスト手順書

## 実装内容

### 完了した機能
1. **推論結果の表示**: サイドパネルに Gemini API からの推論結果を表示
2. **地点情報の表示**: 緯度、経度、CO₂濃度、偏差、観測日を表示
3. **キャッシュインジケーター**: 2回目以降のクリックで「（キャッシュ）」を表示
4. **.env ファイル**: Gemini API キーを設定
5. **Playwright テスト**: 自動テストスクリプトを作成

### 修正したファイル
- `sample_calendar.html:724` - キャッシュインジケーター追加
- `sample_calendar.html:693` - 観測日フィールド追加
- `.env` - Gemini API キー設定
- `app.py` - 静的ファイル配信機能追加
- `test_inference.py` - Playwright テスト作成

## 手動テスト手順

### 前提条件
1. Flask サーバーが起動していること
2. `anomalies202306.geojson` が存在すること
3. `.env` ファイルに Gemini API キーが設定されていること

### テスト手順

#### 1. Flask サーバーを起動
```bash
python app.py
```

サーバーが `http://localhost:5000` で起動することを確認してください。

#### 2. ブラウザで開く
ブラウザで以下のURLを開きます:
```
http://localhost:5000
```

または

```
file:///C:/Users/古部正義/AppData/Local/Temp/vibe-kanban/worktrees/549f-p-9/sample_calendar.html
```

※file:// プロトコルを使う場合、Flask API へのリクエストが失敗する可能性があります。

#### 3. 年月を選択
- **年**: 2023
- **月**: 6月 (June)

データが読み込まれ、地図上にマーカーが表示されます。

#### 4. マーカーをクリック（1回目）
1. 地図上の任意のCO₂マーカーをクリック
2. サイドパネルが右側から開く
3. 「推論中...」のローディングインジケーターが表示される
4. 10-20秒後、推論結果が表示される

**確認項目:**
- [ ] サイドパネルが開く
- [ ] ローディングインジケーターが表示される
- [ ] 推論結果が表示される
- [ ] 地点情報が表示される:
  - [ ] 緯度: XX.XXXX°
  - [ ] 経度: XX.XXXX°
  - [ ] 観測日: oco2_LTCO2_YYYYMMDD...nc
- [ ] 測定データが表示される:
  - [ ] CO₂濃度: XXX.XX ppm
  - [ ] 偏差: +XX.XX ppm
- [ ] AI原因推論セクションに「（キャッシュ）」が**表示されない**
- [ ] 推論テキストが 200-300 文字程度
- [ ] 日本語が正しく表示される

#### 5. サイドパネルを閉じる
右上の「×」ボタンをクリックしてサイドパネルを閉じます。

#### 6. 同じマーカーをクリック（2回目）
同じマーカーをもう一度クリックします。

**確認項目:**
- [ ] サイドパネルが即座に開く（ローディングが短い）
- [ ] AI原因推論セクションに「🤖 AI原因推論 （キャッシュ）」と表示される
- [ ] 推論内容は1回目と同じ

#### 7. 別のマーカーをクリック
異なるマーカーをクリックして、新しい推論が生成されることを確認します。

**確認項目:**
- [ ] ローディングインジケーターが表示される
- [ ] 新しい推論結果が表示される
- [ ] 「（キャッシュ）」が表示されない

#### 8. レイアウト確認
- [ ] テキストが読みやすい
- [ ] 改行とフォーマットが適切
- [ ] スクロールバーが表示され、全文が読める
- [ ] 各セクションが適切に分かれている

## トラブルシューティング

### マーカーが表示されない
- `anomalies202306.geojson` ファイルが存在するか確認
- ブラウザのコンソールでエラーを確認
- Flask サーバーのログを確認

### 推論結果が表示されない
- `.env` ファイルに Gemini API キーが正しく設定されているか確認
- Flask サーバーのコンソールでエラーメッセージを確認
- ブラウザのネットワークタブで API リクエストの状態を確認

### 「（キャッシュ）」が表示されない
- Flask サーバーを再起動してキャッシュをクリア
- 同じマーカーを確実に2回クリックしているか確認
- ブラウザのコンソールで API レスポンスの `cached` フィールドを確認

## 期待される結果

すべての確認項目にチェックが入れば、タスク9は完了です！

## スクリーンショット
テスト実行時にスクリーンショットを撮影して、以下を記録してください:
1. 初回クリック時のサイドパネル（キャッシュなし）
2. 2回目クリック時のサイドパネル（キャッシュあり）
3. 地点情報の表示
4. 推論結果のテキスト
