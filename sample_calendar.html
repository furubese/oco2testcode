<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COâ‚‚ æ¿ƒåº¦å¯è¦–åŒ–ãƒãƒƒãƒ— - æ™‚ç³»åˆ—è¡¨ç¤º</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
    }

    .controls {
      position: absolute;
      top: 10px;
      left: 60px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 200px;
      max-width: 220px;
    }

    .controls h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .date-selector {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 5px;
    }

    .date-selector select {
      padding: 6px 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      background: white;
      cursor: pointer;
    }

    .date-selector select:first-child {
      flex: 1;
    }

    .date-selector select:last-child {
      flex: 0.7;
    }


    .controls .status {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
      line-height: 1.3;
    }

    .legend {
      position: absolute;
      bottom: 30px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .legend h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
      border: 1px solid #333;
    }

    .co2-popup {
      font-size: 14px;
      line-height: 1.4;
    }

    .gradient-marker {
      background: transparent !important;
      border: none !important;
    }

    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
    .side-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      z-index: 2000;
      transition: right 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }

    .side-panel.open {
      right: 0;
    }

    .side-panel-header {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .side-panel-header h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .close-btn:hover {
      background-color: #e9ecef;
      color: #333;
    }

    .side-panel-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .side-panel {
        width: 100%;
        right: -100%;
      }
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .loading-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #666;
      margin: 0;
      font-weight: 500;
    }

  </style>
</head>
<body>
  <div class="controls">
    <h3>COâ‚‚ç•°å¸¸å€¤è¡¨ç¤º</h3>
    <div class="date-selector">
      <select id="yearSelect" onchange="loadDataForSelectedMonth()"></select>
      <select id="monthSelect" onchange="loadDataForSelectedMonth()">
        <option value="01">1æœˆ</option>
        <option value="02">2æœˆ</option>
        <option value="03">3æœˆ</option>
        <option value="04">4æœˆ</option>
        <option value="05">5æœˆ</option>
        <option value="06" selected>6æœˆ</option>
        <option value="07">7æœˆ</option>
        <option value="08">8æœˆ</option>
        <option value="09">9æœˆ</option>
        <option value="10">10æœˆ</option>
        <option value="11">11æœˆ</option>
        <option value="12">12æœˆ</option>
      </select>
    </div>
    <div class="status" id="status">å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
  </div>

  <div class="legend">
    <h4>COâ‚‚æ¿ƒåº¦ (ppm)</h4>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #d73027;"></div>
      <span>â‰¥ 420 (éå¸¸ã«é«˜ã„)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fc8d59;"></div>
      <span>418-420 (é«˜ã„)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fee08b;"></div>
      <span>415-418 (ã‚„ã‚„é«˜ã„)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #d9ef8b;"></div>
      <span>412-415 (æ™®é€š)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #91bfdb;"></div>
      <span>< 412 (ä½ã„)</span>
    </div>
  </div>

  <div id="map"></div>

  <!-- Configuration -->
  <script src="config.js"></script>

  <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
  <div id="sidePanel" class="side-panel">
    <div class="side-panel-header">
      <h3>COâ‚‚ç•°å¸¸å€¤ã®åŸå› æ¨è«–</h3>
      <button class="close-btn" onclick="closeSidePanel()">&times;</button>
    </div>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
      <div class="spinner"></div>
      <p class="loading-text">æ¨è«–ä¸­...</p>
    </div>

    <div class="side-panel-content">
      <p>ã“ã“ã«COâ‚‚ç•°å¸¸å€¤ã®åŸå› æ¨è«–çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      <p>ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®åœ°ç‚¹ã®è©³ç´°ãªåˆ†ææƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let map;
    let co2Layer = null;

    // å¹´ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
    function initYearSelect() {
      const yearSelect = document.getElementById('yearSelect');
      const currentYear = new Date().getFullYear();
      const startYear = 2020;
      const endYear = 2025;

      for (let year = endYear; year >= startYear; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        if (year === 2023) {
          option.selected = true;
        }
        yearSelect.appendChild(option);
      }
    }

    // ãƒãƒƒãƒ—åˆæœŸåŒ–
    function initMap() {
      try {
        map = L.map('map', {
          worldCopyJump: false,
          maxBounds: null,
          maxBoundsViscosity: 0.0
        }).setView([35, 135], 2);

        // OpenStreetMap ã‚¿ã‚¤ãƒ«è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors',
          maxZoom: 18,
          noWrap: false
        }).addTo(map);

        // ãƒãƒƒãƒ—ç§»å‹•æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
        let isAdjusting = false; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ•ãƒ©ã‚°
        map.on('moveend', function() {
          if (isAdjusting) return;

          const center = map.getCenter();
          const lng = center.lng;

          // çµŒåº¦ãŒÂ±180åº¦ã‚’å¤§ããè¶…ãˆãŸã‚‰ã€ãƒãƒƒãƒ—ä¸­å¿ƒã‚’èª¿æ•´
          if (lng > 180 || lng < -180) {
            isAdjusting = true;
            let newLng = lng;
            while (newLng > 180) newLng -= 360;
            while (newLng < -180) newLng += 360;

            map.setView([center.lat, newLng], map.getZoom(), { animate: false });

            setTimeout(function() {
              isAdjusting = false;
            }, 100);
          }
        });

        updateStatus('ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('Map initialization failed:', error);
        updateStatus('ãƒãƒƒãƒ—åˆæœŸåŒ–ã«å¤±æ•—');
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(message) {
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.textContent = message;
      }
    }


    // CO2æ¿ƒåº¦ã«åŸºã¥ãè‰²åˆ†ã‘é–¢æ•°
    function getCO2Color(co2) {
      if (co2 >= 420) return '#d73027';      // èµ¤ - éå¸¸ã«é«˜ã„
      else if (co2 >= 418) return '#fc8d59'; // ã‚ªãƒ¬ãƒ³ã‚¸ - é«˜ã„
      else if (co2 >= 415) return '#fee08b'; // é»„è‰² - ã‚„ã‚„é«˜ã„
      else if (co2 >= 412) return '#d9ef8b'; // è–„ç·‘ - æ™®é€š
      else return '#91bfdb';                 // é’ - ä½ã„
    }


    // CO2ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ 
    function addCO2DataToMap(geoJsonData) {
      if (!map) {
        updateStatus('ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      // æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
      if (co2Layer) {
        map.removeLayer(co2Layer);
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¤‡è£½ã—ã¦ä¸–ç•Œåœ°å›³ã®ãƒ«ãƒ¼ãƒ—ã«å¯¾å¿œ
      const expandedFeatures = [];
      geoJsonData.features.forEach(feature => {
        const coords = feature.geometry.coordinates;
        // å…ƒã®ä½ç½®
        expandedFeatures.push(feature);
        // è¥¿å´ã®è¤‡è£½ (-360)
        expandedFeatures.push({
          ...feature,
          geometry: {
            ...feature.geometry,
            coordinates: [coords[0] - 360, coords[1]]
          }
        });
        // æ±å´ã®è¤‡è£½ (+360)
        expandedFeatures.push({
          ...feature,
          geometry: {
            ...feature.geometry,
            coordinates: [coords[0] + 360, coords[1]]
          }
        });
      });

      const expandedData = {
        type: 'FeatureCollection',
        features: expandedFeatures
      };

      co2Layer = L.geoJSON(expandedData, {
        pointToLayer: function(feature, latlng) {
          const co2 = feature.properties.xco2;
          const deviation = feature.properties.deviation_ppm;
          const color = getCO2Color(co2);

          // åå·®(deviation_ppm)ã«å¿œã˜ã¦å††ã®ã‚µã‚¤ã‚ºã‚’å¤‰æ›´
          let radius = 12;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          if (deviation >= 10) radius = 40;       // 40ppmä»¥ä¸Š: ç‰¹å¤§
          else if (deviation >= 8) radius = 30;  // 30-40ppm: è¶…å¤§
          else if (deviation >= 6) radius = 20;  // 20-30ppm: å¤§
          else if (deviation >= 4) radius = 15;  // 15-20ppm: ä¸­å¤§
          else if (deviation >= 2) radius = 10;  // 10-15ppm: ä¸­
          else radius = 5;                        // 10ppmæœªæº€: å°

          // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å††ã‚’DivIconã§ä½œæˆ
          const size = radius * 2;
          const icon = L.divIcon({
            className: 'gradient-marker',
            html: '<div style="width: ' + size + 'px; height: ' + size + 'px; ' +
                  'border-radius: 50%; ' +
                  'background: radial-gradient(circle, ' + color + ' 0%, ' + color + '99 40%, transparent 70%); ' +
                  'transform: translate(-50%, -50%);"></div>',
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
          });

          return L.marker(latlng, { icon: icon });
        },
        onEachFeature: function(feature, layer) {
          const props = feature.properties;
          const co2Value = props.xco2;
          const uncertainty = props.xco2_uncertainty;
          const severity = props.severity || 'unknown';
          const zscore = props.zscore;
          const deviation = props.deviation_ppm;
          const baseline = props.baseline_mean;
          const detectionDays = props.detection_days;
          const detectionFiles = props.detection_files || [];

          // ç•°å¸¸åº¦ã®æ—¥æœ¬èªè¡¨è¨˜
          let severityText = '';
          if (severity === 'high') severityText = 'é«˜';
          else if (severity === 'medium') severityText = 'ä¸­';
          else if (severity === 'low') severityText = 'ä½';
          else severityText = severity;

          // ãƒ©ãƒ³ã‚¯åˆ¤å®š
          let rank = '';
          if (co2Value >= 420) rank = 'éå¸¸ã«é«˜ã„';
          else if (co2Value >= 418) rank = 'é«˜ã„';
          else if (co2Value >= 415) rank = 'ã‚„ã‚„é«˜ã„';
          else if (co2Value >= 412) rank = 'æ™®é€š';
          else rank = 'ä½ã„';

          // ç·¯åº¦çµŒåº¦ã‚’å–å¾—
          const coords = feature.geometry.coordinates;
          const lon = coords[0].toFixed(4);
          const lat = coords[1].toFixed(4);

          layer.bindPopup(
            '<div class="co2-popup">' +
            '<h4 style="margin: 0 0 8px 0; color: ' + getCO2Color(co2Value) + ';">COâ‚‚æ¿ƒåº¦: ' + co2Value.toFixed(2) + ' ppm</h4>' +
            '<div style="margin-bottom: 4px;"><strong>ç·¯åº¦:</strong> ' + lat + 'Â°</div>' +
            '<div style="margin-bottom: 4px;"><strong>çµŒåº¦:</strong> ' + lon + 'Â°</div>' +
            '<div style="margin-bottom: 4px;"><strong>ä¸ç¢ºå®Ÿæ€§:</strong> Â±' + uncertainty.toFixed(2) + ' ppm</div>' +
            '<div style="margin-bottom: 4px;"><strong>ç•°å¸¸åº¦:</strong> ' + severityText + '</div>' +
            '<div style="margin-bottom: 4px;"><strong>æ¤œå‡ºæ—¥æ•°:</strong> ' + detectionDays + 'æ—¥</div>' +
            '<div style="margin-bottom: 4px;"><strong>åŸºæº–å€¤:</strong> ' + baseline.toFixed(2) + ' ppm</div>' +
            '<div style="margin-bottom: 4px;"><strong>åå·®:</strong> +' + deviation.toFixed(2) + ' ppm</div>' +
            '<div style="margin-bottom: 4px;"><strong>Z-Score:</strong> ' + zscore.toFixed(2) + '</div>' +
            '<div style="font-size: 11px; color: #666; margin-top: 8px;"><strong>æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«æ•°:</strong> ' + detectionFiles.length + 'å€‹</div>' +
            '</div>',
            {
              maxWidth: 320
            }
          );

          // å…ƒã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã—ã¦ä¿å­˜ï¼ˆåå·®ã«åŸºã¥ãï¼‰
          const color = getCO2Color(co2Value);
          let radius = 12;
          if (deviation >= 10) radius = 40;
          else if (deviation >= 8) radius = 30;
          else if (deviation >= 6) radius = 20;
          else if (deviation >= 4) radius = 15;
          else if (deviation >= 2) radius = 10;
          else radius = 5;

          const originalSize = radius * 2;
          const hoverSize = originalSize + 8;

          // ãƒ›ãƒãƒ¼çŠ¶æ…‹ã‚’ç®¡ç†
          let isHovered = false;

          // ãƒ›ãƒãƒ¼åŠ¹æœ
          layer.on('mouseover', function(e) {
            if (isHovered) return; // æ—¢ã«ãƒ›ãƒãƒ¼ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
            isHovered = true;

            const newIcon = L.divIcon({
              className: 'gradient-marker',
              html: '<div style="width: ' + hoverSize + 'px; height: ' + hoverSize + 'px; ' +
                    'border-radius: 50%; ' +
                    'background: radial-gradient(circle, ' + color + ' 0%, ' + color + '99 40%, transparent 70%); ' +
                    'transform: translate(-50%, -50%);"></div>',
              iconSize: [hoverSize, hoverSize],
              iconAnchor: [hoverSize / 2, hoverSize / 2]
            });
            this.setIcon(newIcon);
          });

          layer.on('mouseout', function(e) {
            if (!isHovered) return; // ãƒ›ãƒãƒ¼ä¸­ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            isHovered = false;

            const originalIcon = L.divIcon({
              className: 'gradient-marker',
              html: '<div style="width: ' + originalSize + 'px; height: ' + originalSize + 'px; ' +
                    'border-radius: 50%; ' +
                    'background: radial-gradient(circle, ' + color + ' 0%, ' + color + '99 40%, transparent 70%); ' +
                    'transform: translate(-50%, -50%);"></div>',
              iconSize: [originalSize, originalSize],
              iconAnchor: [originalSize / 2, originalSize / 2]
            });
            this.setIcon(originalIcon);
          });

          // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‹ã
          layer.on('click', async function(e) {
            // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‹ã
            const panel = document.getElementById('sidePanel');
            const contentArea = panel.querySelector('.side-panel-content');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‹ã
            panel.classList.add('open');

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            contentArea.innerHTML = '';
            loadingIndicator.style.display = 'flex';

            // APIå‘¼ã³å‡ºã—ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            const apiData = {
              lat: coords[1],
              lon: coords[0],
              co2: props.xco2,
              deviation: props.deviation_ppm,
              date: props.detection_files && props.detection_files.length > 0 ? props.detection_files[0] : 'unknown',
              severity: props.severity || 'unknown',
              zscore: props.zscore
            };

            try {
              // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š: 30ç§’
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), 30000);

              try {
                // API Gateway URL from config (falls back to local development)
                const apiUrl = window.APP_CONFIG ? window.APP_CONFIG.API_GATEWAY_URL : 'http://localhost:5000';
                const endpoint = window.APP_CONFIG ? window.APP_CONFIG.ENDPOINTS.REASONING : '/api/reasoning';

                // Flask API or API Gatewayã¸POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                const response = await fetch(`${apiUrl}${endpoint}`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(apiData),
                  signal: controller.signal
                });

                clearTimeout(timeoutId);

                // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                if (!response.ok) {
                  let errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';

                  if (response.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                  } else if (response.status === 404) {
                    errorMessage = 'APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                  } else if (response.status === 400) {
                    errorMessage = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
                  } else if (response.status === 401 || response.status === 403) {
                    errorMessage = 'APIã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                  }

                  throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('API Response:', result);

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                loadingIndicator.style.display = 'none';

                // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
                const content = generateSidePanelContentWithAPI(props, coords, result);
                contentArea.innerHTML = content;

              } catch (fetchError) {
                clearTimeout(timeoutId);
                throw fetchError;
              }

            } catch (error) {
              console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);

              // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
              loadingIndicator.style.display = 'none';

              // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
              let errorMessage = '';
              let errorTitle = '';

              if (error.name === 'AbortError') {
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼
                errorTitle = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼';
                errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ï¼ˆ30ç§’è¶…éï¼‰ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã‹ã€ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
              } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('fetch')) {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼æœªèµ·å‹•ãªã©ï¼‰
                errorTitle = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼';
                errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Flaskã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
              } else {
                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ï¼ˆAPIã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
                errorTitle = 'ã‚¨ãƒ©ãƒ¼';
                errorMessage = error.message || 'AIæ¨è«–ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
              }

              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
              const content = generateSidePanelContent(props, coords);
              const errorBox = `
                <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #f5c6cb;">
                  <h4 style="margin: 0 0 8px 0; font-size: 15px; font-weight: 600;">âš ï¸ ${errorTitle}</h4>
                  <p style="margin: 0; font-size: 13px; line-height: 1.5;">${errorMessage}</p>
                  <p style="margin: 10px 0 0 0; font-size: 12px; color: #856404; background-color: #fff3cd; padding: 8px; border-radius: 4px;">
                    ğŸ’¡ åˆ¥ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                  </p>
                </div>
              `;
              contentArea.innerHTML = content + errorBox;
            }
          });
        }
      }).addTo(map);

      updateStatus(geoJsonData.features.length + 'ä»¶ã®COâ‚‚ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­');
    }

    // é¸æŠã•ã‚ŒãŸå¹´æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    async function loadDataForSelectedMonth() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const year = yearSelect.value;
      const month = monthSelect.value;

      if (!year || !month) {
        updateStatus('å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const yearMonth = year + month;
        const filename = `anomalies${yearMonth}.geojson`;

        updateStatus(`${year}å¹´${month}æœˆã®ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...`);

        // Construct the GeoJSON file path
        // In production (CloudFront), files are served from /data/geojson/
        // In local development, files are served from root
        const geojsonPath = window.APP_CONFIG && window.APP_CONFIG.CLOUDFRONT_URL
          ? `${window.APP_CONFIG.ENDPOINTS.GEOJSON}/${filename}`
          : filename;

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
        const timestamp = new Date().getTime();
        const response = await fetch(`${geojsonPath}?t=${timestamp}`);

        if (!response.ok) {
          throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${filename}`);
        }

        const geoJsonData = await response.json();
        console.log('Loaded CO2 anomaly data:', geoJsonData.features.length, 'points');

        addCO2DataToMap(geoJsonData);
        updateStatus(`${year}å¹´${month}æœˆè¡¨ç¤º (${geoJsonData.features.length}åœ°ç‚¹)`);

      } catch (error) {
        console.error('Failed to load data:', error);
        updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
    function generateSidePanelContentWithAPI(props, coords, apiResult) {
      const co2Value = props.xco2;
      const uncertainty = props.xco2_uncertainty;
      const severity = props.severity || 'unknown';
      const zscore = props.zscore;
      const deviation = props.deviation_ppm;
      const baseline = props.baseline_mean;
      const detectionDays = props.detection_days;
      const detectionFiles = props.detection_files || [];

      // ç•°å¸¸åº¦ã®æ—¥æœ¬èªè¡¨è¨˜
      let severityText = '';
      if (severity === 'high') severityText = 'é«˜';
      else if (severity === 'medium') severityText = 'ä¸­';
      else if (severity === 'low') severityText = 'ä½';
      else severityText = severity;

      // ãƒ©ãƒ³ã‚¯åˆ¤å®š
      let rank = '';
      if (co2Value >= 420) rank = 'éå¸¸ã«é«˜ã„';
      else if (co2Value >= 418) rank = 'é«˜ã„';
      else if (co2Value >= 415) rank = 'ã‚„ã‚„é«˜ã„';
      else if (co2Value >= 412) rank = 'æ™®é€š';
      else rank = 'ä½ã„';

      const lon = coords[0].toFixed(4);
      const lat = coords[1].toFixed(4);
      const color = getCO2Color(co2Value);

      // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æ¨è«–çµæœã‚’å–å¾—
      const reasoning = apiResult.reasoning || 'AIæ¨è«–çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';

      return `
        <div style="padding: 0;">
          <div style="background-color: ${color}; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 0;">
            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">${co2Value.toFixed(2)} ppm</h2>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">COâ‚‚æ¿ƒåº¦ãƒ¬ãƒ™ãƒ«: ${rank}</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">ğŸ“ ä½ç½®æƒ…å ±</h4>
            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
              <span style="color: #666;">ç·¯åº¦:</span>
              <span style="font-weight: 500;">${lat}Â°</span>
              <span style="color: #666;">çµŒåº¦:</span>
              <span style="font-weight: 500;">${lon}Â°</span>
              <span style="color: #666;">è¦³æ¸¬æ—¥:</span>
              <span style="font-weight: 500;">${detectionFiles[0] || 'N/A'}</span>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">ğŸ“Š æ¸¬å®šãƒ‡ãƒ¼ã‚¿</h4>
            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
              <span style="color: #666;">ä¸ç¢ºå®Ÿæ€§:</span>
              <span style="font-weight: 500;">Â±${uncertainty.toFixed(2)} ppm</span>
              <span style="color: #666;">åŸºæº–å€¤:</span>
              <span style="font-weight: 500;">${baseline.toFixed(2)} ppm</span>
              <span style="color: #666;">åå·®:</span>
              <span style="font-weight: 500; color: #d73027;">+${deviation.toFixed(2)} ppm</span>
              <span style="color: #666;">Z-Score:</span>
              <span style="font-weight: 500;">${zscore.toFixed(2)}</span>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">âš ï¸ ç•°å¸¸æ¤œå‡ºæƒ…å ±</h4>
            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
              <span style="color: #666;">ç•°å¸¸åº¦:</span>
              <span style="font-weight: 500;">${severityText}</span>
              <span style="color: #666;">æ¤œå‡ºæ—¥æ•°:</span>
              <span style="font-weight: 500;">${detectionDays}æ—¥</span>
              <span style="color: #666;">æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«:</span>
              <span style="font-weight: 500;">${detectionFiles.length}å€‹</span>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">ğŸ¤– AIåŸå› æ¨è«–${apiResult.cached ? ' ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰' : ''}</h4>
            <div style="background-color: #f8f9fa; padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.6; white-space: pre-wrap;">
              ${reasoning}
            </div>
          </div>

          <div style="font-size: 12px; color: #999; text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            æ¤œå‡ºæœŸé–“: ${detectionDays}æ—¥é–“ | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: OCO-2è¡›æ˜Ÿè¦³æ¸¬ | AIæ¨è«–: Gemini
          </div>
        </div>
      `;
    }

    // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆï¼ˆAPIãªã—ç‰ˆï¼‰
    function generateSidePanelContent(props, coords) {
      const co2Value = props.xco2;
      const uncertainty = props.xco2_uncertainty;
      const severity = props.severity || 'unknown';
      const zscore = props.zscore;
      const deviation = props.deviation_ppm;
      const baseline = props.baseline_mean;
      const detectionDays = props.detection_days;
      const detectionFiles = props.detection_files || [];

      // ç•°å¸¸åº¦ã®æ—¥æœ¬èªè¡¨è¨˜
      let severityText = '';
      if (severity === 'high') severityText = 'é«˜';
      else if (severity === 'medium') severityText = 'ä¸­';
      else if (severity === 'low') severityText = 'ä½';
      else severityText = severity;

      // ãƒ©ãƒ³ã‚¯åˆ¤å®š
      let rank = '';
      if (co2Value >= 420) rank = 'éå¸¸ã«é«˜ã„';
      else if (co2Value >= 418) rank = 'é«˜ã„';
      else if (co2Value >= 415) rank = 'ã‚„ã‚„é«˜ã„';
      else if (co2Value >= 412) rank = 'æ™®é€š';
      else rank = 'ä½ã„';

      const lon = coords[0].toFixed(4);
      const lat = coords[1].toFixed(4);
      const color = getCO2Color(co2Value);

      return `
        <div style="padding: 0;">
          <div style="background-color: ${color}; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 0;">
            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">${co2Value.toFixed(2)} ppm</h2>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">COâ‚‚æ¿ƒåº¦ãƒ¬ãƒ™ãƒ«: ${rank}</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">ğŸ“ ä½ç½®æƒ…å ±</h4>
            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
              <span style="color: #666;">ç·¯åº¦:</span>
              <span style="font-weight: 500;">${lat}Â°</span>
              <span style="color: #666;">çµŒåº¦:</span>
              <span style="font-weight: 500;">${lon}Â°</span>
              <span style="color: #666;">è¦³æ¸¬æ—¥:</span>
              <span style="font-weight: 500;">${detectionFiles[0] || 'N/A'}</span>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">ğŸ“Š æ¸¬å®šãƒ‡ãƒ¼ã‚¿</h4>
            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
              <span style="color: #666;">ä¸ç¢ºå®Ÿæ€§:</span>
              <span style="font-weight: 500;">Â±${uncertainty.toFixed(2)} ppm</span>
              <span style="color: #666;">åŸºæº–å€¤:</span>
              <span style="font-weight: 500;">${baseline.toFixed(2)} ppm</span>
              <span style="color: #666;">åå·®:</span>
              <span style="font-weight: 500; color: #d73027;">+${deviation.toFixed(2)} ppm</span>
              <span style="color: #666;">Z-Score:</span>
              <span style="font-weight: 500;">${zscore.toFixed(2)}</span>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">âš ï¸ ç•°å¸¸æ¤œå‡ºæƒ…å ±</h4>
            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
              <span style="color: #666;">ç•°å¸¸åº¦:</span>
              <span style="font-weight: 500;">${severityText}</span>
              <span style="color: #666;">æ¤œå‡ºæ—¥æ•°:</span>
              <span style="font-weight: 500;">${detectionDays}æ—¥</span>
              <span style="color: #666;">æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«:</span>
              <span style="font-weight: 500;">${detectionFiles.length}å€‹</span>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; font-size: 16px; color: #333; border-bottom: 2px solid #dee2e6; padding-bottom: 5px;">ğŸ’¡ åŸå› æ¨è«–</h4>
            <div style="background-color: #f8f9fa; padding: 12px; border-radius: 8px; font-size: 14px; line-height: 1.6;">
              <p style="margin: 0 0 10px 0;">ã“ã®åœ°ç‚¹ã§ã¯ã€åŸºæº–å€¤ã‚ˆã‚Š<strong>+${deviation.toFixed(2)} ppm</strong>é«˜ã„ç•°å¸¸å€¤ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚</p>
              <p style="margin: 0 0 10px 0;"><strong>æƒ³å®šã•ã‚Œã‚‹åŸå› :</strong></p>
              <ul style="margin: 0; padding-left: 20px;">
                ${deviation >= 10 ? '<li>å¤§è¦æ¨¡ãªç”£æ¥­æ´»å‹•ã‚„æ£®æ—ç«ç½ã®å¯èƒ½æ€§</li>' : ''}
                ${deviation >= 6 ? '<li>éƒ½å¸‚éƒ¨ã®äº¤é€šé‡å¢—åŠ ã«ã‚ˆã‚‹æ’å‡º</li>' : ''}
                ${deviation >= 4 ? '<li>å­£ç¯€çš„ãªæ¤ç”Ÿå¤‰åŒ–ã®å½±éŸ¿</li>' : ''}
                ${deviation >= 2 ? '<li>å±€åœ°çš„ãªäººç‚ºçš„æ´»å‹•</li>' : ''}
                ${deviation < 2 ? '<li>è‡ªç„¶å¤‰å‹•ã®ç¯„å›²å†…</li>' : ''}
              </ul>
            </div>
          </div>

          <div style="font-size: 12px; color: #999; text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            æ¤œå‡ºæœŸé–“: ${detectionDays}æ—¥é–“ | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: OCO-2è¡›æ˜Ÿè¦³æ¸¬
          </div>
        </div>
      `;
    }

    // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«é–‹é–‰åˆ¶å¾¡é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼‰
    window.openSidePanel = function(content) {
      const panel = document.getElementById('sidePanel');
      const contentArea = panel.querySelector('.side-panel-content');

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
      if (content) {
        contentArea.innerHTML = content;
      }

      // ãƒ‘ãƒãƒ«ã‚’é–‹ã
      panel.classList.add('open');
    }

    window.closeSidePanel = function() {
      const panel = document.getElementById('sidePanel');
      panel.classList.remove('open');
    }

    // ãƒ‘ãƒãƒ«ã®é–‹é–‰çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
    window.toggleSidePanel = function() {
      const panel = document.getElementById('sidePanel');
      if (panel.classList.contains('open')) {
        window.closeSidePanel();
      } else {
        window.openSidePanel();
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    window.addEventListener('load', function() {
      // å¹´ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
      initYearSelect();

      // LeafletãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
      setTimeout(function() {
        if (typeof L !== 'undefined') {
          initMap();
        } else {
          updateStatus('Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—');
        }
      }, 100);
    });

  </script>
</body>
</html>
